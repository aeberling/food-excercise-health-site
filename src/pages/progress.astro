---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
---

<Layout title="Mediterranean Power Plan - Progress">
  <Navigation />
  
  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="text-center mb-8">
      <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white rounded-xl p-8 shadow-lg">
        <h1 class="text-4xl font-bold mb-2">Your Progress</h1>
        <p class="text-xl opacity-90 font-sans">Mediterranean Health Journey Tracking</p>
      </div>
    </header>

    <!-- Summary Cards -->
    <section class="grid md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8" id="summary-section">
      <div class="bg-white rounded-xl shadow-md p-6 border border-emerald-100">
        <div class="text-3xl mb-2">üìÖ</div>
        <h3 class="text-lg font-semibold text-emerald-700 mb-2">Total Days</h3>
        <p class="text-3xl font-bold text-emerald-600" id="total-days">0</p>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 border border-amber-100">
        <div class="text-3xl mb-2">üçΩÔ∏è</div>
        <h3 class="text-lg font-semibold text-amber-700 mb-2">Meals Completed</h3>
        <p class="text-3xl font-bold text-amber-600" id="meals-percentage">0%</p>
        <p class="text-sm text-slate-600 mt-1" id="meals-detail">0/0 meals</p>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 border border-red-100">
        <div class="text-3xl mb-2">üí™</div>
        <h3 class="text-lg font-semibold text-red-700 mb-2">Exercise Rate</h3>
        <p class="text-3xl font-bold text-red-600" id="exercise-percentage">0%</p>
        <p class="text-sm text-slate-600 mt-1" id="exercise-detail">0/0 workouts</p>
      </div>

      <div class="bg-white rounded-xl shadow-md p-6 border border-blue-100">
        <div class="text-3xl mb-2">üíß</div>
        <h3 class="text-lg font-semibold text-blue-700 mb-2">Avg Water</h3>
        <p class="text-3xl font-bold text-blue-600" id="water-average">0</p>
        <p class="text-sm text-slate-600 mt-1">glasses/day</p>
      </div>
    </section>

    <!-- Detailed Progress -->
    <section class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-2xl font-bold text-emerald-700 mb-6">Daily Breakdown</h2>
      
      <div class="grid md:grid-cols-3 gap-6 mb-6">
        <!-- Breakfast Progress -->
        <div class="text-center">
          <h3 class="text-lg font-semibold text-amber-700 mb-3">üç≥ Breakfast</h3>
          <div class="bg-amber-100 rounded-full p-4 mb-3 inline-block">
            <div class="text-2xl font-bold text-amber-600" id="breakfast-percentage">0%</div>
          </div>
          <p class="text-sm text-slate-600" id="breakfast-detail">0/0 completed</p>
        </div>

        <!-- Lunch Progress -->
        <div class="text-center">
          <h3 class="text-lg font-semibold text-emerald-700 mb-3">ü•ó Lunch</h3>
          <div class="bg-emerald-100 rounded-full p-4 mb-3 inline-block">
            <div class="text-2xl font-bold text-emerald-600" id="lunch-percentage">0%</div>
          </div>
          <p class="text-sm text-slate-600" id="lunch-detail">0/0 completed</p>
        </div>

        <!-- Dinner Progress -->
        <div class="text-center">
          <h3 class="text-lg font-semibold text-blue-700 mb-3">üçΩÔ∏è Dinner</h3>
          <div class="bg-blue-100 rounded-full p-4 mb-3 inline-block">
            <div class="text-2xl font-bold text-blue-600" id="dinner-percentage">0%</div>
          </div>
          <p class="text-sm text-slate-600" id="dinner-detail">0/0 completed</p>
        </div>
      </div>
    </section>

    <!-- Recent Activity -->
    <section class="bg-white rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-2xl font-bold text-emerald-700 mb-6">Recent Activity</h2>
      <div id="recent-activity" class="space-y-3">
        <!-- Activity items will be populated by JavaScript -->
      </div>
    </section>

    <!-- Export & Actions -->
    <section class="text-center">
      <button onclick="exportToCSV()" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-3 rounded-lg font-medium mr-4">
        üìÑ Export to CSV
      </button>
      <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-medium">
        üóëÔ∏è Clear All Data
      </button>
      <div class="mt-4">
        <a href="/today" class="text-emerald-600 hover:text-emerald-700 font-medium">‚Üê Back to Today's Plan</a>
      </div>
    </section>

    <!-- OAuth Test Section -->
    <section class="mt-8 bg-slate-50 rounded-xl p-6 border border-slate-200">
      <h2 class="text-2xl font-bold text-slate-700 mb-6">üß™ Google Sheets OAuth Test</h2>
      <p class="text-gray-600 mb-4">Test your Google OAuth credentials:</p>
      
      <div class="space-x-2 mb-4">
        <button onclick="testOAuthAuth()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium text-sm">
          üîë Test OAuth
        </button>
        <button onclick="testOAuthWrite()" id="oauth-write-btn" disabled class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium text-sm disabled:bg-gray-400">
          ‚úèÔ∏è Test Write
        </button>
      </div>
      
      <div id="oauth-status" class="text-sm"></div>
    </section>
  </main>

  <script>
    import { SimpleUnifiedTracker } from '../utils/simpleUnifiedTracker';

    let tracker = null;

    document.addEventListener('DOMContentLoaded', () => {
      tracker = new SimpleUnifiedTracker();
      loadProgressData();
    });

    function loadProgressData() {
      if (!tracker) return;

      const summary = tracker.getSummary();
      const allData = tracker.getAllData();
      
      // Update summary cards
      document.getElementById('total-days').textContent = summary.totalDays.toString();
      
      // Calculate meal completion rate
      const totalMeals = summary.totalDays * 3; // 3 meals per day
      const completedMeals = summary.breakfastCompleted + summary.lunchCompleted + summary.dinnerCompleted;
      const mealPercentage = totalMeals > 0 ? Math.round((completedMeals / totalMeals) * 100) : 0;
      
      document.getElementById('meals-percentage').textContent = `${mealPercentage}%`;
      document.getElementById('meals-detail').textContent = `${completedMeals}/${totalMeals} meals`;
      
      // Exercise completion rate
      const exercisePercentage = summary.totalDays > 0 ? Math.round((summary.exerciseCompleted / summary.totalDays) * 100) : 0;
      document.getElementById('exercise-percentage').textContent = `${exercisePercentage}%`;
      document.getElementById('exercise-detail').textContent = `${summary.exerciseCompleted}/${summary.totalDays} workouts`;
      
      // Water average
      document.getElementById('water-average').textContent = summary.averageWater.toString();

      // Individual meal percentages
      const breakfastPercentage = summary.totalDays > 0 ? Math.round((summary.breakfastCompleted / summary.totalDays) * 100) : 0;
      const lunchPercentage = summary.totalDays > 0 ? Math.round((summary.lunchCompleted / summary.totalDays) * 100) : 0;
      const dinnerPercentage = summary.totalDays > 0 ? Math.round((summary.dinnerCompleted / summary.totalDays) * 100) : 0;

      document.getElementById('breakfast-percentage').textContent = `${breakfastPercentage}%`;
      document.getElementById('breakfast-detail').textContent = `${summary.breakfastCompleted}/${summary.totalDays} completed`;
      
      document.getElementById('lunch-percentage').textContent = `${lunchPercentage}%`;
      document.getElementById('lunch-detail').textContent = `${summary.lunchCompleted}/${summary.totalDays} completed`;
      
      document.getElementById('dinner-percentage').textContent = `${dinnerPercentage}%`;
      document.getElementById('dinner-detail').textContent = `${summary.dinnerCompleted}/${summary.totalDays} completed`;

      // Load recent activity
      loadRecentActivity(allData);
    }

    function loadRecentActivity(allData) {
      const container = document.getElementById('recent-activity');
      if (!container) return;

      const entries = Object.values(allData)
        .sort((a, b) => b.date.localeCompare(a.date))
        .slice(0, 7); // Show last 7 days

      if (entries.length === 0) {
        container.innerHTML = '<p class="text-slate-500 text-center">No tracking data yet. Start using the app to see your progress!</p>';
        return;
      }

      container.innerHTML = entries.map(entry => {
        const date = new Date(entry.date).toLocaleDateString('en-US', { 
          weekday: 'short', 
          month: 'short', 
          day: 'numeric' 
        });
        
        const completedItems = [];
        if (entry.breakfast) completedItems.push('üç≥ Breakfast');
        if (entry.lunch) completedItems.push('ü•ó Lunch');
        if (entry.dinner) completedItems.push('üçΩÔ∏è Dinner');
        if (entry.exercise) completedItems.push('üí™ Exercise');
        if (entry.waterGlasses > 0) completedItems.push(`üíß ${entry.waterGlasses} glasses`);

        return `
          <div class="flex justify-between items-center p-4 bg-slate-50 rounded-lg">
            <div>
              <div class="font-semibold text-slate-700">${date}</div>
              <div class="text-sm text-slate-600">
                ${completedItems.length > 0 ? completedItems.join(', ') : 'No activities completed'}
              </div>
            </div>
            <div class="text-emerald-600 font-medium">
              ${completedItems.length}/5 completed
            </div>
          </div>
        `;
      }).join('');
    }

    function exportToCSV() {
      if (!tracker) {
        alert('Tracker not initialized. Please refresh the page.');
        return;
      }

      const csvContent = tracker.exportToCSV();
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = url;
      a.download = `mediterranean-diet-tracking-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      alert('CSV file downloaded! You can now import this into Google Sheets or Excel.');
    }

    function clearAllData() {
      if (confirm('Are you sure you want to clear all tracking data? This cannot be undone.')) {
        localStorage.removeItem('mediterranean-health-tracking');
        localStorage.removeItem('waterCount');
        alert('All data cleared!');
        location.reload();
      }
    }

    // OAuth Test Functions
    let oauthToken = null;
    
    async function testOAuthAuth() {
      const CLIENT_ID = '138578049962-vn0b4sqin897dfv168b3j47h9ovpn6jf.apps.googleusercontent.com';
      const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';
      
      showOAuthStatus('Loading Google Identity Services...', 'info');
      
      // Load Google Identity Services
      const script = document.createElement('script');
      script.src = 'https://accounts.google.com/gsi/client';
      script.onload = () => {
        try {
          // @ts-ignore
          const tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPE,
            callback: (response) => {
              if (response.error) {
                showOAuthStatus(`‚ùå Auth failed: ${response.error}`, 'error');
              } else {
                oauthToken = response.access_token;
                showOAuthStatus('‚úÖ OAuth successful! You can now test write.', 'success');
                document.getElementById('oauth-write-btn').disabled = false;
              }
            }
          });
          tokenClient.requestAccessToken();
        } catch (error) {
          showOAuthStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      };
      document.head.appendChild(script);
    }
    
    async function testOAuthWrite() {
      if (!oauthToken) {
        showOAuthStatus('‚ùå Please authenticate first', 'error');
        return;
      }
      
      const SPREADSHEET_ID = '1aqt7R8n6prJCkRmCan1cHs2FQsIxVW1FC56gcFpM__U';
      const testData = [[
        new Date().toISOString().split('T')[0],
        'TRUE', 'TRUE', 'FALSE', 'TRUE', '7',
        `OAuth Test - ${new Date().toLocaleTimeString()}`
      ]];
      
      showOAuthStatus('Writing to Google Sheets...', 'info');
      
      try {
        const response = await fetch(
          `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/Sheet1!A:G:append?valueInputOption=RAW`,
          {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${oauthToken}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ values: testData })
          }
        );
        
        if (response.ok) {
          const result = await response.json();
          showOAuthStatus(`‚úÖ Write successful! Updated range: ${result.updates?.updatedRange}`, 'success');
        } else {
          const error = await response.json();
          showOAuthStatus(`‚ùå Write failed: ${error.error?.message}`, 'error');
        }
      } catch (error) {
        showOAuthStatus(`‚ùå Error: ${error.message}`, 'error');
      }
    }
    
    function showOAuthStatus(message, type) {
      const status = document.getElementById('oauth-status');
      const colors = {
        info: 'text-blue-600',
        success: 'text-green-600',
        error: 'text-red-600'
      };
      status.className = `text-sm ${colors[type] || 'text-gray-600'}`;
      status.textContent = message;
    }

    // Make functions available globally
    window.exportToCSV = exportToCSV;
    window.clearAllData = clearAllData;
    window.testOAuthAuth = testOAuthAuth;
    window.testOAuthWrite = testOAuthWrite;
  </script>
</Layout>